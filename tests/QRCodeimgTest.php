<?php

namespace mad\otputil\tests;

use chillerlan\Authenticator\Base32;
use mad\otputil\models\Secret;
use mad\otputil\widgets\QRCodeimg;

class QRCodeimgTest extends TestCase
{
    // Tests:

    public function testGenerateQRCode()
    {
        $base32 = new Base32();
        $exp = '<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAYAAAAGACAIAAAArpSLoAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAGQklEQVR4nO3dy24aQQBFQWPl/z8ZZZtkEbWg8elH1doyzABHs7nqx/P5/AIofNdvALiXAAEZAQIyAgRkBAjICBCQESAgI0BARoCAjAABGQECMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGQECMgIEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQESAgI0BARoCAjAABGQECMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGQECMgIEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQ+VW/gSHf30L5l+fzOfJnc+/b4IsOGnxvyZUeYO6H9Tk+NiAjQEBGgICMAAEZAQIyAgRkBAjICBCQESAgI0BARoCAjAABmT3GqIN2GeD9RzIfvWfJ6RuymqMuBtiLAAEZAQIyAgRkBAjICBCQESAgI0BARoCAjAABGQECMgIEZI4aow5K5nzJDDI5fdTg8zUH3LcXeAICMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGQECMgIEJC5cYzKa2xWmc4TEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQESAgI0BARoCAjDEqkw8CtTJlnCcgICNAQEaAgIwAARkBAjICBGQECMgIEJARICAjQEBGgICMAAGZG8eo96wl77nSudy3H+MJCMgIEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQESAgI0BA5qgx6twTPg8weEMGt5cr/7dBviGr8XkAGQECMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGQECMg8HALJ3ImmbxTjPAEBGQECMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGQECMjscTLqygdaJkd3rnyW6Vz3HKC68omyn7PuDxs4ngABGQECMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGT2GKMOWnmiOfjfkg2hlekKL3ontwbICBCQESAgI0BARoCAjAABGQECMgIEZAQIyAgQkBEgICNAQOaxxQmKc+d8pob/uGcBO9fKX6QtftdfnoCAkAABGQECMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGSOOhl10D2rv8ErTc4LnWvlPe3K9y3nCQjICBCQESAgI0BARoCAjAABGQECMgIEZAQIyAgQkBEgICNAQOaoMWpyUmVywufK+8a5E83k9iYr05U/08/xBARkBAjICBCQESAgI0BARoCAjAABGQECMgIEZAQIyAgQkBEgILPHGDXZ6d05DnzfAfctWTUPOuD2/skTEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQESAgI0BARoCAzB5j1OR4zJUNLhJXPn10ruQ4Viejvm/7bx6wLwECMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGQECMjsMUYddMCcL9mFrnwQaGLlEW8ylP2c7b8rwL4ECMgIEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQESAgc9QYddABg8+5DjgIdPASVh7KrvzePufGawYWIUBARoCAjAABGQECMgIEZAQIyAgQkBEgICNAQEaAgIwAAZkbx6j3uGdlmmx95763la/0czwBARkBAjICBGQECMgIEJARICAjQEBGgICMAAEZAQIyAgRkBAjIGKMy2T2jSivT93kCAjICBGQECMgIEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQuXGMeufq732Do8q5/23u4HOuwfd2z1GxL/AEBGQECMgIEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQESAgc9QYNVkkHuCeXWiy5Jz7orusTAf5xQIZAQIyAgRkBAjICBCQESAgI0BARoCAjAABGQECMgIEZAQIyDwO27YBG/EEBGQECMgIEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQESAgI0BARoCAjAABGQECMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGQECMgIEJARICAjQEBGgICMAAEZAQIyAgRkBAjICBCQESAgI0BARoCAjAABGQECMgIEZAQIyAgQkBEgICNAQEaAgIwAARkBAjICBGQECMgIEJARICAjQEBGgICMAAGZ362DAfBGj4q7AAAAAElFTkSuQmCC" alt="QRCode">';

        $s = new Secret();
        $s->secret = $base32->fromString('random');
        $s->digits = 6;
        $s->mode = 'totp';
        $s->algo = 'SHA1';
        $s->period = 30;
        $s->save();

        ob_start();
        $img = QRCodeimg::widget([
                    'sid' => $s->id,
                    'username' => 'foo',
                    'label' => 'bar'
                ]);
        ob_end_clean();

        $this->assertEquals($exp, $img);
    }
}
